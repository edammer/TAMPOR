# Tunable Approach for Median Polish of Ratio <BR> - Walkthrough by Example
####
## 1. Sample Data for 3 Batches
####
Consider 3 batches of protein measurements for 5 samples in each batch. Each batch also included pooled equal mixture (a "physical average," or GIS) of all 15 samples, as 2 technical replicates intrabatch.
Therefore, there are a total of (5+2)+(5+2)+(5+2) = 21 samples including 6 GIS samples in 3 distinct batches were measured for proteomics in our example.

We will consider the "complete" proteomic set as 10 protein isoform measurements for this example (instead of 100s to 1000s).
####
####  **_Proteomic Abundances (3 batches)_**:
|                 | b1.02_GIS | b1.03_CT | b1.04_AD | b1.05_AS | b1.06_AS | b1.07_AD | b1.24_GIS |  | b2.25_GIS | b2.26_AD | b2.27_AD | b2.28_CT | b2.29_AS | b2.30_CT | b2.45_GIS |  | b3.46_GIS | b3.47_AS | b3.48_CT | b3.49_AD | b3.50_AD | b3.51_CT | b3.65_GIS |
|:----------------|:----------|:-----------------------|:------------------|:-------------------|:-----------------|:-----------------|:----------|:-|-----------|:-----------------|:-----------------|:---------------------|:-----------------|:---------------------|:----------|:-|:----------|:------------------|:-----------------------|:----------------|:-----------------|:----------------------|:----------|
| GFAP (P14136) | 1550 | 353.78 | 1580 | 563.39 | 651.6 | 344.48 | 1610 |  | 1570 | 4910 | 1130 | 167.85 | 731.72 | 185.43 | 1560 |  | 1540 | 644.05 | 514.95 | 2570 | 245.5 | 3770 | 267.7 |
| MBP (P02686) | 1210 | 2550 | 2680 | 1670 | 1080 | 548.46 | 1200 |  | 1220 | 2370 | 1140 | 566.1 | 1820 | 555.79 | 1290 |  | 1370 | 350.79 | 1320 | 1570 | 4870 | 848.96 | 542.25 |
| TUBB4B (P68371) | 751.99 | 790.17 | 842.31 | 979.16 | 856.94 | 827.74 | 728.28 |  | 775.72 | 669.87 | 940.68 | 961.6 | 982.29 | 866.73 | 947.55 |  | 879.87 | 755.7 | 794 | 747.92 | 704.35 | 682.87 | 1020 |
| HBB (P68871) | 344.18 | 362.29 | 397.73 | 170.63 | 205.36 | 724.5 | 386.44 |  | 329.15 | 368.43 | 180.14 | 285.71 | 188.75 | 237.1 | 381.78 |  | 394.69 | 245.03 | 597.57 | 303.43 | 335.5 | 676.59 | 316.2 |
| YWHAZ (P63104) | 182.47 | 207.28 | 214.34 | 152.99 | 234.05 | 158.95 | 187.91 |  | 184.75 | 182.65 | 169.73 | 191.7 | 319.4 | 233.32 | 220.27 |  | 199.72 | 340.78 | 228.35 | 169.27 | 123.79 | 152.26 | 179.72 |
| NEFM (P07197) | 142.19 | 199.91 | 200.26 | 172.98 | 171.46 | 136.42 | 130.96 |  | 144.01 | 242.95 | 212.04 | 100.36 | 240.45 | 78.027 | 159.86 |  | 151.98 | 99.516 | 288.86 | 141.9 | 357.95 | 122.12 | 142.28 |
| PGAM1 (P18669) | 45.631 | 65.825 | 56.537 | 48.155 | 58.914 | 40.902 | 48.586 |  | 51.099 | 46.976 | 31.263 | 52.412 | 70.9 | 70.648 | 46.606 |  | 49.359 | 58.51 | 75.706 | 46.772 | 37.51 | 50.406 | 39.298 |
| MAPT (P10636) | 48.173 | 35.397 | 41.331 | 38.151 | 31.916 | 71.625 | 50.786 |  | 56.027 | 74.067 | 36.702 | 38.565 | 35.61 | 48.831 | 52.012 |  | 48.13 | 65.15 | 35.936 | 28.798 | 36.269 | 26.887 | 54.403 |
| HSP90B1 (P14625) | 16.595 | 18.13 | 14.107 | 12.986 | 16.463 | 18.463 | 16.05 |  | 16.06 | 14.212 | 19.85 | 18.235 | 13.677 | 24.948 | 15.423 |  | 16.434 | 14.73 | 18.054 | 14.66 | 16.576 | 20.876 | 16.809 |
| MT-CO2 (P00403) | 11.409 | 8.3655 | 10.606 | 10.184 | 16.988 | 12.78 | 13.217 |  | 13.724 | 10.756 | 19.44 | 12.738 | 12.916 | 25.502 | 16.458 |  | 14.601 | 15.827 | 7.0446 | 14.499 | 2.8296 | 12.851 | 19.762 |
####
The above table with explicit rownames and colnames will be the variable **dat** in our R session.
Each of the non-GIS channels are a randomized sample of diagnosis Alzheimer's Disease (AD), asymptomatic AD (AS), or control (CT) tissue.
####
## 2. TAMPOR row sweep with hybrid equation for log2(ratio)
####
The equation for TAMPOR leveraging both GIS and non-GIS samples is defined
  for each row **i**, each sample **j**, and each batch **k**(1:n) over **n** batches as follows:
####
![alt text](https://github.com/edammer/TAMPOR/blob/master/Equation2.JPG "MDS improvement of 50 batch TMT proteomics data")
####
Before starting calculations, let's set up some convenient ways of indexing the above data in **dat**.
####
```
batches<-c("b1","b2","b3")

GISindices<-list()
GISindices[["b1"]]<-c(1,7)
GISindices[["b2"]]<-c(8,14)
GISindices[["b3"]]<-c(15,21)

colIndices<-list()
colIndices[["b1"]]<-c(1:7)
colIndices[["b2"]]<-c(8:14)
colIndices[["b3"]]<-c(15:21)

# Load the data, keep a backup (.original)
dat.original<-read.csv(file="mode3_synaptosome_10proteins.csv",header=TRUE,row.names=1)
```
  
The first term of the transformation divides the unlogged abundance value by the median intrabatch GIS abundance, which can be calculated over each row (i) for each batch (k) as:
```
denominators.term1 = sapply(batches,function(batch) {
                                    apply(dat[,GISindices[[batch]] ], 1, median) }
                           )

denominators.term1
```
Evalutates to:
|        | b1  | b2  | b3  |
|:-------|:----|:----|:----|
GFAP | 1580.0000 | 1565.0000 | 903.8500 |
MBP | 1205.0000 | 1255.0000 | 956.1250 |
TUBB4B | 740.1350 | 861.6350 | 949.9350 |
HBB | 365.3100 | 355.4650 | 355.4450 |
YWHAZ | 185.1900 | 202.5100 | 189.7200 |
NEFM | 136.5750 | 151.9350 | 147.1300 |
PGAM1 | 47.1085 | 48.8525 | 44.3285 |
MAPT | 49.4795 | 54.0195 | 51.2665 |
HSP90B1 | 16.3225 | 15.7415 | 16.6215 |
MT-CO2 | 12.3130 | 15.0910 | 17.1815 |

And the second term denominators evaluate with the following logic:
                             
```
denominators.term2 = sapply(batches,function(batch) {
                                    apply(dat[, colIndices[[batch]] ], 1, function(i.kn) {
                                          # define relative positions (columns) in row, for batch subset
                                          offset=colIndices[[batch]][1] -1
                                          intrabatchIndices.GIS=GISindices[[batch]] - offset
                                          intrabatchIndices.allCol=colIndices[[batch]] - offset
                                          intrabatchIndices.nonGIS=intrabatchIndices.allCol[which(!intrabatchIndices.allCol %in% intrabatchIndices.GIS)]
                                          # perform calculation of second term denominator
                                          median(  i.kn[intrabatchIndices.nonGIS] / median(i.kn[intrabatchIndices.GIS])  )  }
                                         )  }
                           )

denominators.term2
```

Evalutating to:
|        | b1  | b2  | b3  |
|:-------|:----|:----|:----|
GFAP |     0.3565759 | 0.4675527 | 0.7125629 |
MBP | 1.3858921 | 0.9083665 | 1.3805726 |
TUBB4B | 1.1380491 | 1.0917384 | 0.7873381 |
HBB | 0.9917330 | 0.6670136 | 0.9438872 |
YWHAZ | 1.1192829 | 0.9466199 | 0.8922096 |
NEFM | 1.2665568 | 1.3955968 | 0.9644532 |
PGAM1 | 1.2001443 | 1.0728622 | 1.1371014 |
MAPT | 0.7710466 | 0.7139089 | 0.7009646 |
HSP90B1 | 1.0086078 | 1.1584029 | 0.9972626 |
MT-CO2 | 0.8613660 | 0.8558744 | 0.7479556 |

Note the grand medians of the above batchwise denominators are a rowwise median across the 3 batches, for each row, and these fulfill the second term numerator calculation.
So, finally, the row sweep can be performed, as follows:

```
numerators.term2 = apply(denominators.term2,1,median)
term2 = sapply(batches,function(batch) { numerators.term2 / denominators.term2[,batch] } )

dat.rowSweep = t(sapply(rownames(dat), function(i) {
                              sapply(batches,function(batch) {
                                                    dat[i, colIndices[[batch]] ] / denominators.term1[i,batch] * term2[i,batch] }
                                    )  }
                     ))
colnames(dat.rowSweep)<-colnames(dat)

dat.rowSweep
```
|                 | b1.02_GIS | b1.03_CT | b1.04_AD | b1.05_AS | b1.06_AS | b1.07_AD | b1.24_GIS |  | b2.25_GIS | b2.26_AD | b2.27_AD | b2.28_CT | b2.29_AS | b2.30_CT | b2.45_GIS |  | b3.46_GIS | b3.47_AS | b3.48_CT | b3.49_AD | b3.50_AD | b3.51_CT | b3.65_GIS |
|:----------------|:----------|:-----------------------|:------------------|:-------------------|:-----------------|:-----------------|:----------|:-|-----------|:-----------------|:-----------------|:---------------------|:-----------------|:---------------------|:----------|:-|:----------|:------------------|:-----------------------|:----------------|:-----------------|:----------------------|:----------|
GFAP | 1.28633222 | 0.293599105 | 1.311228972 | 0.467552716 | 0.540757467 | 0.285881112 | 1.336125725 | | 1.003194888 | 3.137380192 | 0.722044728 | 0.107252396 | 0.467552716 | 0.118485623 | 0.996805112 | | 1.117974043 | 0.467552716 | 0.373831645 | 1.865709928 | 0.178222485 | 2.736858533 | 0.194338735
MBP | 1.000295135 | 2.108059995 | 2.21552972 | 1.380572624 | 0.892825409 | 0.453406504 | 0.992028233 | | 1.477454913 | 2.870137823 | 1.380572624 | 0.6855633 | 2.204072084 | 0.673077595 | 1.562226916 | | 1.432867041 | 0.366887175 | 1.380572624 | 1.642044712 | 5.093476271 | 0.887917375 | 0.567132959
TUBB4B | 0.974672443 | 1.024158465 | 1.091738381 | 1.269112979 | 1.110700678 | 1.072853851 | 0.943941338 | | 0.900288405 | 0.777440564 | 1.091738381 | 1.116017803 | 1.140030291 | 1.005913177 | 1.099711595 | | 1.284345718 | 1.103094842 | 1.15900133 | 1.091738381 | 1.028139278 | 0.996784935 | 1.488893396
HBB | 0.896704602 | 0.94388724 | 1.036220354 | 0.44454851 | 0.535031835 | 1.887566053 | 1.006806108 | | 1.310335238 | 1.466707616 | 0.717131368 | 1.137402038 | 0.751407493 | 0.94388724 | 1.519853524 | | 1.110410893 | 0.689361223 | 1.68118837 | 0.853662311 | 0.94388724 | 1.903501245 | 0.889589107
YWHAZ | 0.833315982 | 0.94661992 | 0.978861992 | 0.698684782 | 1.068874914 | 0.725903301 | 0.858159732 | | 0.912300627 | 0.901930769 | 0.83813145 | 0.94661992 | 1.577206064 | 1.152140635 | 1.087699373 | | 1.116907488 | 1.905766742 | 1.277016948 | 0.94661992 | 0.69227908 | 0.851493762 | 1.005060153
NEFM | 1.041112942 | 1.463737873 | 1.466300567 | 1.266556837 | 1.255427421 | 0.998865092 | 0.958887058 | | 0.860200198 | 1.451188377 | 1.266556837 | 0.59947012 | 1.436255383 | 0.466070696 | 0.954875382 | | 1.356527893 | 0.888249966 | 2.578277716 | 1.266556837 | 3.194954332 | 1.09000649 | 1.269948603
PGAM1 | 0.917754295 | 1.323906478 | 1.137101413 | 0.96851829 | 1.184908868 | 0.822642199 | 0.977186785 | | 1.1086153 | 1.019165 | 0.678264548 | 1.137101413 | 1.538206712 | 1.532739461 | 1.011137687 | | 1.113482297 | 1.319918337 | 1.707840328 | 1.055122551 | 0.846182479 | 1.137101413 | 0.886517703
MAPT | 0.901447716 | 0.662374044 | 0.773415306 | 0.713908866 | 0.597235076 | 1.340298355 | 0.950344046 | | 1.037162506 | 1.371115986 | 0.67942132 | 0.713908866 | 0.659206398 | 0.903951351 | 0.962837494 | | 0.956156326 | 1.294277678 | 0.713908866 | 0.572104506 | 0.720524284 | 0.534140352 | 1.080776493
HSP90B1 | 1.016694747 | 1.110736713 | 0.864267116 | 0.795588911 | 1.00860775 | 1.131138 | 0.983305253 | | 0.888304934 | 0.786089024 | 1.097936048 | 1.00860775 | 0.756497296 | 1.379914787 | 0.853071419 | | 0.999967409 | 0.896283311 | 1.098540318 | 0.892023987 | 1.00860775 | 1.270251894 | 1.022785212
MT-CO2 |0.920674203 | 0.675072315 | 0.855874362 | 0.821820149 | 1.370883808 | 1.031310046 | 1.066574717 | | 0.909416208 | 0.712742694 | 1.288185011 | 0.844079253 | 0.855874362 | 1.689881386 | 1.090583792 | | 0.972424057 | 1.054075444 | 0.469169133 | 0.965630875 | 0.188450867 | 0.855874362 | 1.316145759

And with a log2-transform of the ratio, the column sweep can be performed as a subtraction of each column's, sample's, median log2(ratio):
  
```
dat.rowSweep.log2 <- apply(dat.rowSweep,2,function(x) log2(as.numeric(x)))
rownames(dat.rowSweep.log2)<-rownames(dat.rowSweep)

dat.colSweep = apply(dat.rowSweep.log2,2,function(x) { x -median(x) } )
# This data centers around a log2(abundance/central tendency) value of 0 (ratios of 1).
                                                    
# Return data to the form of unlogged abundance, by taking the antilog (2^x), and multiplying by previous protein (row) medians.
dat <- (2^dat.colSweep)*apply(dat,1,median)

dat
```
|                 | b1.02_GIS | b1.03_CT | b1.04_AD | b1.05_AS | b1.06_AS | b1.07_AD | b1.24_GIS |  | b2.25_GIS | b2.26_AD | b2.27_AD | b2.28_CT | b2.29_AS | b2.30_CT | b2.45_GIS |  | b3.46_GIS | b3.47_AS | b3.48_CT | b3.49_AD | b3.50_AD | b3.51_CT | b3.65_GIS |
|:----------------|:----------|:-----------------------|:------------------|:-------------------|:-----------------|:-----------------|:----------|:-|-----------|:-----------------|:-----------------|:---------------------|:-----------------|:---------------------|:----------|:-|:----------|:------------------|:-----------------------|:----------------|:-----------------|:----------------------|:----------|
GFAP | 993.6095171 | 218.18669 | 902.0655841 | 423.0997379 | 381.0858806 | 206.1020662 | 997.3768396 | | 767.3060001 | 1942.015663 | 552.3236875 | 87.79554863 | 346.347698 | 88.97546698 | 695.4975336 | | 733.5443667 | 351.9792055 | 224.8436826 | 1352.483651 | 145.9201776 | 1921.241683 | 140.254256
MBP | 1288.26633 | 2611.989328 | 2541.27733 | 2082.985922 | 1049.063506 | 545.0038045 | 1234.669985 | | 1884.136771 | 2962.124001 | 1760.774459 | 935.6813198 | 2722.214986 | 842.7226352 | 1817.374202 | | 1567.528567 | 460.5044786 | 1384.454829 | 1984.667623 | 6953.157168 | 1039.243006 | 682.4274223
TUBB4B | 851.6679399 | 860.9733376 | 849.6247844 | 1299.156514 | 885.4547804 | 874.9565067 | 797.0874583 | | 778.9578488 | 544.3795367 | 944.707065 | 1033.440871 | 955.3161716 | 854.5040663 | 867.9868763 | | 953.2912907 | 939.3951073 | 788.5651491 | 895.2730204 | 952.256228 | 791.5532448 | 1215.540123
HBB | 317.584715 | 321.6186617 | 326.8581321 | 184.450115 | 172.8811153 | 623.9454765 | 344.5921613 | | 459.529401 | 416.2715442 | 251.5219468 | 426.9009236 | 255.2142042 | 324.9917478 | 486.2220737 | | 334.0611552 | 237.9473499 | 463.6268761 | 283.7406817 | 354.3403158 | 612.6753606 | 294.3701256
YWHAZ | 165.3016821 | 180.6567249 | 172.9362389 | 162.3672456 | 193.4426284 | 134.3942295 | 164.5072536 | | 179.1951388 | 143.3718033 | 164.6442894 | 198.9968031 | 300.0372157 | 222.1851764 | 194.8943202 | | 188.1987937 | 368.435215 | 197.2451149 | 176.225401 | 145.5589884 | 153.5027246 | 186.274626
NEFM | 167.0328742 | 225.9323144 | 209.5193288 | 238.0555826 | 183.7610474 | 149.570255 | 148.6691728 | | 136.6546256 | 186.5738975 | 201.2314079 | 101.9235516 | 220.9809852 | 72.69389369 | 138.3800709 | | 184.8693477 | 138.8874924 | 322.0889589 | 190.7014957 | 543.3241676 | 158.9279382 | 190.3637877
PGAM1 | 47.8200964 | 66.36701129 | 52.7691627 | 59.12095296 | 56.32830844 | 40.00638352 | 49.20519591 | | 57.19862364 | 42.55508925 | 34.99855485 | 62.78936911 | 76.86309191 | 77.64158365 | 47.59014875 | | 49.28325792 | 67.02779179 | 69.29044005 | 51.59554845 | 46.73457623 | 53.845607 | 43.15841805
MAPT | 39.33092178 | 27.80403455 | 30.05407233 | 36.49101434 | 23.7736917 | 54.57947521 | 40.07041116 | | 44.80856952 | 47.93919752 | 29.35619243 | 33.00952359 | 27.58253149 | 38.34252109 | 37.94628978 | | 35.4368048 | 55.03574774 | 24.25372177 | 23.42579062 | 33.32210772 | 21.17951578 | 44.05787595
HSP90B1 | 17.66921384 | 18.57157369 | 13.37739709 | 16.19813247 | 15.9921438 | 18.34748446 | 16.51445954 | | 15.28654751 | 10.94766155 | 18.89603412 | 18.57598479 | 12.60820189 | 23.31422271 | 13.39167133 | | 14.76197835 | 15.18083937 | 14.86567663 | 14.54884399 | 18.57972182 | 20.06243093 | 16.60753478
MT-CO2 | 12.55311999 | 8.855374556 | 10.39328185 | 13.12719898 | 17.05312951 | 13.12409129 | 14.05355988 | | 12.27804115 | 7.78756103 | 17.39365773 | 12.19640478 | 11.19115342 | 22.3997903 | 13.43159188 | | 11.26246544 | 14.00687424 | 4.981007215 | 12.35612108 | 2.723542176 | 10.60529562 | 16.76655267

__Repeat until convergence or maximum number of iterations (typically 250) is reached.__
